# Lab file upload (1→6)

* Trọng tâm: code php của ltv, mod-php ,apache

![image.png](image%2043.png)

# level1:

- Công cụ: burpsuite, docker desktop, visual studio code

1. Dowload file_upload.zip

![image.png](image%2044.png)

1. Đưa vào visual studio code

![image.png](image%2045.png)

1. Mở terminal chạy lệnh docker-compose up --build

![image.png](image%2046.png)

![image.png](image%2047.png)

1. Truy cập localhost:12001

![image.png](image%2048.png)

![image.png](image%2049.png)

![image.png](image%2050.png)

1. Upload file test.php

![image.png](image%2051.png)

![image.png](image%2052.png)

Truy cập [http://localhost:12001/upload/e2b5d95656d7ef9cc5ed63da62b4daa4/test.php](http://localhost:12001/upload/e2b5d95656d7ef9cc5ed63da62b4daa4/test.php)

![image.png](image%2053.png)

- phpinfo(); //chỉ là một lệnh ví dụ để chứng minh rằng giả thiết thành công
1. Upload file shell php

![image.png](image%2054.png)

![image.png](image%2055.png)

![image.png](image%2056.png)

![image.png](image%2057.png)

# level 2(thao túng việc lưu trữ file):

- Công cụ: burpsuite, docker desktop, visual studio code

![image.png](image%2058.png)

1. Vào localhost:12002

![image.png](image%2059.png)

1. Upload file test.php 

![image.png](image%2051.png)

![image.png](image%2060.png)

1. So sánh code của level 1 và level 2

![image.png](image%2061.png)

![image.png](image%2062.png)

![image.png](image%2063.png)

1. Debug bằng var_dump

- var_dump toàn bộ kết quả trả về của explode

![image.png](image%2064.png)

![image.png](image%2065.png)

- Nhận thấy phần tử có index là 1 có chuỗi php thỏa mãn điều kiện dòng 21,22,23

![image.png](image%2066.png)

![image.png](image%2067.png)

![image.png](image%2068.png)

- Upload 1 file test.txt.php và gửi

![image.png](image%2069.png)

![image.png](image%2070.png)

![image.png](image%2071.png)

![image.png](image%2072.png)

- Upload file shell.txt.php

![image.png](image%2073.png)

# level3(thao túng việc lưu trữ file):

- Công cụ: burpsuite, docker desktop, visual studio code

![image.png](image%2074.png)

![image.png](image%2075.png)

-  Nếu upload 1 file có phần đuôi cuối cùng là php sẽ thông báo “Hack detected”

- Đặt giả thiết:

![image.png](image%2076.png)

![image.png](image%2077.png)

![image.png](image%2078.png)

![image.png](image%2079.png)

![image.png](image%2080.png)

—> Các đuôi như .phtml, .phar, .php5, .php7 đôi khi vẫn được xử lý là PHP do **Apache, Nginx,** hoặc **PHP-FPM** có thể được cấu hình mở rộng để xử lý nhiều phần mở rộng file là PHP chứ không chỉ .php

Trong level3, các đuôi được xử lý là PHP :.phtml, .php, .phar

![image.png](image%2081.png)

![image.png](image%2082.png)

![image.png](image%2083.png)

# level4(thao túng việc xử lý file):

- Công cụ: burpsuite, docker desktop, visual studio code

![image.png](image%2084.png)

![image.png](image%2085.png)

- nếu như có php,phtml,phar sẽ hiện thông báo “Hack detected”

- 3 levels hack đầu tiên đều là hành vi có sẵn của Apache và code PHP của developer

- Ngoài những config mặc định, apache còn hỗ trợ 1 loại file nữa là .htaccess

- .htaccess là loại config cục bộ chỉ có tác dụng với thư mục đang chứa nó, ngang hàng hoặc sâu hơn trong thư mục đang chứa nó.

- config AllowOverride có tác dụng cho phép trang web dùng .htaccess

AllowOverride None (2.3.9 và trở về sau), AllowOverride All(2.3.8 và trở về trước)

- level 4 cho phép dùng .htaccess

![image.png](image%2086.png)

- giải level4 cần 2 bước:

+Bước 1: Upload 1 file .htaccess để tạo config cho mod-php với đuôi file tùy thích

![image.png](image%2087.png)

- config cho tất cả đuôi file nào là .phhl sẽ chạy được php

+Bước 2: Upload file test.phhl

![image.png](image%2088.png)

![image.png](image%2089.png)

Vì sao lúc up file .htaccess lên, khi kiểm tra kết quả ở link upload thì hiện Forbidden.

![image.png](image%2090.png)

—> Do mặc định Apache2 httpd sẽ ngăn cản người dùng truy cập vào những file có đầu là .ht*

![image.png](image%2091.png)

# level5(thao túng việc lưu trữ file):

- Công cụ: burpsuite, docker desktop, visual studio code

![image.png](image%2092.png)

![image.png](image%2093.png)

- Đoạn code trên kiểm tra xem MIME type của file khi người dùng upload có nằm trong danh sách cho phép không. 
- Nếu không sẽ in ra “Hack detected”

- Vì MIME type này được **trình duyệt tự khai báo** trong phần Content-type nên có thể giả mạo MIME type bằng cách sửa trong request.

![image.png](image%2094.png)

![image.png](image%2095.png)

# level6(thao túng việc lưu trữ file):

- Công cụ: burpsuite, docker desktop, visual studio code

![image.png](image%2096.png)

![image.png](image%2097.png)

- Đoạn code trên lọc file tải lên chỉ cho phép các file có MIME type là:

- image/jpg
- image/png
- image/gif

- Đoạn code dùng finfo_file() để đọc byte đầu của file thực tế, không dựa vào $_FILES['file']['type'], nên tránh được việc hacker gửi sai Content-type ở client**.**

- Nhưng finfo_file() dùng để **đọc các** byte đầu (magic bytes) của một file nhằm xác định loại ****MIME ****thực sự của file đó, không phụ thuộc vào đuôi file hoặc header HTTP do client gửi.

—> Gửi 1 file php có byte đầu của 1 file gif,ipg,png

![image.png](image%2098.png)

![image.png](image%2099.png)

![image.png](image%20100.png)

![image.png](image%20101.png)

![image.png](image%20102.png)

![image.png](image%20103.png)